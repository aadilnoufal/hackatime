<div class="container">
  <%# Normalize possibly-nil collections to arrays to avoid NoMethodError on .first/.any?/etc %>
  <% todays_langs = Array(@todays_languages) %>
  <% todays_editors = Array(@todays_editors) %>
  <!-- Workspace Hero -->
  <section class="hx-hero mt-6 mb-14">
    <div class="hx-hero-grid">
      <div class="hx-hero-main">
        <% if current_user %>
          <h1 class="hx-hero-title">Welcome back<span class="sr-only">,</span> <span class="hx-hero-wave" aria-hidden="true">👋</span></h1>
          <p class="hx-hero-lead">Stay consistent. Track your flow. Build your streak.</p>
          <div class="hx-cta-row">
            <a href="#mini_leaderboard_container" class="btn btn-primary">Live stats</a>
            <a href="#dashboard_container" class="btn btn-ghost">Dashboard</a>
          </div>
          <div class="hx-inline-chips" aria-label="today overview">
            <div class="hx-chip">
              <span class="hx-chip-value"><%= short_time_detailed @todays_duration %></span>
              <span class="hx-chip-label">today logged</span>
            </div>
            <div class="hx-chip">
              <span class="hx-chip-value"><%= todays_langs.first(2).join(', ') if todays_langs.any? %></span>
              <span class="hx-chip-label">languages</span>
            </div>
            <div class="hx-chip">
              <span class="hx-chip-value"><%= todays_editors.first if todays_editors.any? %></span>
              <span class="hx-chip-label">editor</span>
            </div>
          </div>
        <% else %>
          <h1 class="hx-hero-title">See where your coding time really goes.</h1>
          <p class="hx-hero-lead">Built by students for students. Yours first. Public when you want.</p>
          <div class="hx-cta-row">
            <a href="#signup" class="btn btn-primary">Get started</a>
            <a href="<%= docs_path %>" class="btn btn-ghost">Docs</a>
          </div>
          <% if @home_stats&.[](:seconds_tracked) && @home_stats&.[](:users_tracked) %>
            <% hours_total = (@home_stats[:seconds_tracked] / 3600.0).to_i %>
            <% avg_per = @home_stats[:users_tracked] > 0 ? (hours_total / @home_stats[:users_tracked].to_f).round(1) : 0 %>
            <div class="hx-inline-chips" aria-label="platform stats">
              <div class="hx-chip">
                <span class="hx-chip-value"><%= number_with_delimiter(hours_total) %>h</span>
                <span class="hx-chip-label">tracked</span>
              </div>
              <div class="hx-chip">
                <span class="hx-chip-value"><%= number_with_delimiter(@home_stats[:users_tracked]) %></span>
                <span class="hx-chip-label">students</span>
              </div>
              <div class="hx-chip">
                <span class="hx-chip-value"><%= avg_per %>h</span>
                <span class="hx-chip-label">avg / user</span>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
      <div class="hx-hero-side">
        <div class="hx-code-window" aria-live="polite" aria-label="recent activity snippet">
          <div class="hx-code-window-bar">
            <span class="dot red"></span><span class="dot yellow"></span><span class="dot orange"></span>
            <span class="hx-code-filename">session_stats.json</span>
          </div>
          <pre class="hx-code-block"><code id="live-snippet"><%= raw({
            today: short_time_detailed(@todays_duration),
            top_lang: (todays_langs.first || 'N/A'),
            editors: todays_editors.first(2),
            streak: current_user&.streak || nil
          }.to_json) %></code></pre>
        </div>
        <p class="hx-side-note">Updates as you code • Private by default</p>
      </div>
    </div>
  </section>

  <% if current_user&.trust_level == "red" %>
    <div class="soft-card alert-red p-5 text-center mb-10">
      <div class="flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16"><path fill="currentColor" fill-rule="evenodd" d="M8 14.5a6.5 6.5 0 1 0 0-13a6.5 6.5 0 0 0 0 13M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m1-5a1 1 0 1 1-2 0a1 1 0 0 1 2 0m-.25-6.25a.75.75 0 0 0-1.5 0v3.5a.75.75 0 0 0 1.5 0z" clip-rule="evenodd" /></svg>
        <span class="text-3xl font-bold block ml-2">Hold up! Your account has been banned for suspicious activity.</span>
      </div>
      <div>
        <p class="text-primary text-left text-lg mb-2"><b>What does this mean?</b> Your account was convicted for fraud or abuse of Hackatime, such as using methods to gain an unfair advantage on the leaderboards or attempting to manipulate your coding time in any way. This restricts your access to participate in public leaderboards, but Hackatime will still track and display your time. This may also affect your ability to participate in current and future Hack Club events.</p>
        <p class="text-primary text-left text-lg mb-2"><b>What can I do?</b> Account bans are non-negotiable, and will not be removed unless determined to have been issued incorrectly. In that case, it will automatically be removed. We take fraud very seriously and have a zero-tolerance policy for abuse. If you believe this was a mistake, please DM the <a href="https://hackclub.slack.com/team/U091HC53CE8" target="_blank" class="underline">Fraud Department</a> on Slack. We do not respond in any other channel.</p>
        <p class="text-primary text-left text-lg mb-0"><b>Can I know what caused this?</b> No. We do not disclose the patterns that were detected. Releasing this information would only benefit fraudsters. The fraud team regularly investigates claims of false bans to increase the effectiveness of our detection systems to combat fraud.</p>
      </div>
    </div>
  <% end %>
  <div class="flex items-center space-x-2 mt-2">
    <p class="italic text-gray-400 m-0">
      <%= @flavor_text %>
    </p>
  </div>
  <h1 class="font-bold mt-1 mb-1 text-5xl hidden">
    <% if current_user %>
      Keep Track of <span class="text-primary">Your</span> Coding Time
    <% else %>
      Free Coding Time Tracker - See How Much You <span class="text-primary">Code</span>
    <% end %>
  </h1>
  <p class="font-thin italic text-gray-400">
    <%= @usage_social_proof&.downcase %>
  </p>
  <% unless current_user %>
  <div class="soft-card p-8 mt-4" id="intro">
      <p class="text-xl mt-0 mb-6 fade-reveal delay-[60ms]">
        See which programming languages you use most and how productive you are. Free and works with over <%= link_to "75 code editors", docs_path + "#supported-editors" %>!
      </p>
      <% if @home_stats&.[](:seconds_tracked) && @home_stats&.[](:users_tracked) %>
        <div class="stat-block fade-reveal delay-[120ms]">
          <h2 class="text-3xl my-2 font-bold tracking-tight gradient-text-small">
            Already tracking <span class="text-primary"><%= number_with_delimiter(@home_stats[:seconds_tracked] / 3600) %> <%= 'hour'.pluralize(@home_stats[:seconds_tracked] / 3600) %></span>
            of coding across <span class="text-primary"><%= number_with_delimiter(@home_stats[:users_tracked]) %> <%= 'high schooler'.pluralize(@home_stats[:users_tracked]) %></span>
            since <span class="text-primary">2025</span>.
          </h2>
          <div class="progress-outer mt-4">
            <% hours = (@home_stats[:seconds_tracked] / 3600.0).to_i %>
            <% pct = [[(hours / 1_000_000.0) * 100, 100].min, 0].max %>
            <div class="progress-inner" style="--progress:<%= pct %>%"></div>
            <div class="progress-glow"></div>
          </div>
          <p class="mt-2 text-sm text-gray-400 italic">Community goal: 1,000,000 hours — we're at <%= number_with_delimiter(hours) %>!</p>
        </div>
      <% end %>
      <div class="my-10 feature-list-grid fade-reveal delay-[180ms]">
        <ul class="feature-grid">
          <li>✅ <strong>100% Free</strong></li>
          <li>📊 <strong>75+ Editors</strong></li>
          <li>📡 <strong>Works Offline</strong></li>
          <li>🔒 <strong>Privacy First</strong></li>
          <li>⚡ <strong>Real-time Stats</strong></li>
          <li>🏆 <strong>Leaderboards</strong></li>
        </ul>
      </div>
    </div>
  <% end %>
  <% if current_user %>
    <% if @show_wakatime_setup_notice %>
  <div class="text-left my-8 flex flex-col soft-card p-6 gap-2">
        <p class="mb-4 text-xl text-primary">
          Hello friend! Looks like you are new around here, let's get you set up so you can start tracking your coding time.
        </p>
        <%= link_to "Let's setup Hackatime! Click me :D", my_wakatime_setup_path, class: "inline-block w-auto text-3xl font-bold px-8 py-4 bg-primary text-white rounded shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-300 animate-pulse" %>
        <div class="flex items-center mt-4 flex-nowrap">
          <% if @ssp_users_recent&.any? %>
            <div class="flex m-0 ml-0 flex-shrink-0">
              <% @ssp_users_recent.each_with_index do |user, index| %>
                <div class="relative cursor-pointer transition-transform duration-200 hover:-translate-y-1 hover:z-10 group <%= index > 0 ? '-ml-4' : '' %>">
                  <div class="absolute -top-9 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-2 py-1 rounded text-xs whitespace-nowrap opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-20">
                    <%= h(user[:display_name]) %>
                    <div class="absolute top-full left-1/2 -ml-1 border-l-2 border-r-2 border-t-2 border-transparent border-t-gray-800"></div>
                  </div>
                  <img src="<%= user[:avatar_url] %>" alt="<%= h(user[:display_name]) %>" class="w-10 h-10 rounded-full border-2 border-primary object-cover shadow-sm">
                </div>
              <% end %>
              <% if @ssp_users_size && @ssp_users_size > 5 %>
                <div class="relative cursor-pointer transition-transform duration-200 hover:-translate-y-1 hover:z-10 group -ml-4" title="See all <%= @ssp_users_size %> users">
                  <div class="w-10 h-10 rounded-full border-2 border-primary bg-primary text-white font-bold text-sm flex items-center justify-center shadow-sm">+<%= @ssp_users_size - 5 %></div>
                  <div class="absolute left-[-20px] top-11 bg-gray-800 rounded-lg shadow-xl p-4 w-80 z-50 max-h-96 overflow-y-auto opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                    <h4 class="mt-0 mb-2 text-base text-gray-200 border-b border-gray-600 pb-2">All users who set up Hackatime</h4>
                    <div class="flex flex-col gap-2">
                      <% @ssp_users_recent.each do |user| %>
                        <div class="flex items-center p-1 rounded hover:bg-gray-700 transition-colors duration-200">
                          <img src="<%= user[:avatar_url] %>" alt="<%= h(user[:display_name]) %>" class="w-8 h-8 rounded-full mr-2 border border-primary">
                          <span class="font-medium text-sm"><%= h(user[:display_name]) %></span>
                        </div>
                      <% end %>
                    </div>
                    <div class="absolute -top-2 left-8 w-0 h-0 border-l-2 border-r-2 border-b-2 border-transparent border-b-gray-800"></div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
          <% if @ssp_message %>
            <p class="m-0 ml-2 italic text-gray-400"><%= @ssp_message %> (this is real data)</p>
          <% end %>
        </div>
      </div>
    <% end %>
  <p class="soft-card p-4 mt-6">
      <% if @show_logged_time_sentence %>
        You've logged
        <%= short_time_detailed @todays_duration %>
        <% if todays_langs.any? || todays_editors.any? %>
          across
          <% if todays_langs.any? %>
            <% if todays_langs.length >= 4 %>
              <%= todays_langs[0..1].join(", ") %> <span title="<%= todays_langs[2..].join(", ") %>">(& <%= pluralize(todays_langs.length - 2, 'other language') %>)</span>
            <% else %>
              <%= todays_langs.to_sentence %>
            <% end %>
          <% end %>
          <% if todays_langs.any? && todays_editors.any? %>
            using
          <% end %>
          <% if todays_editors.any? %>
            <%= todays_editors.to_sentence %>
          <% end %>
        <% end %>
      <% else %>
        No time logged today... but you can change that!
      <% end %>
    </p>
    <div class="grid gap-8 my-10">
      <div class="soft-card p-4" id="mini_leaderboard_container">
        <h3 class="m-0 mb-3 text-xl font-semibold tracking-wide">Mini Leaderboard</h3>
        <%= turbo_frame_tag "mini_leaderboard", src: mini_leaderboard_static_pages_path do %>
          <%= render "leaderboards/mini_leaderboard_loading" %>
        <% end %>
      </div>
  <div class="soft-card p-4" id="dashboard_container">
        <h3 class="m-0 mb-3 text-xl font-semibold tracking-wide">Dashboard</h3>
        <%= turbo_frame_tag "filterable_dashboard", src: filterable_dashboard_static_pages_path do %>
          <span>Loading...</span>
        <% end %>
      </div>
  <div class="soft-card p-4" id="activity_container">
        <h3 class="m-0 mb-3 text-xl font-semibold tracking-wide">Activity Graph</h3>
        <%= turbo_frame_tag "activity_graph", src: activity_graph_static_pages_path do %>
          <span>Loading...</span>
        <% end %>
      </div>
    </div>
  <% else %>
    <% if @leaderboard %>
      <div class="soft-card p-6" id="top_today">
        <h3 class="m-0 mb-4 text-2xl font-bold tracking-tight gradient-text-small">Today's Top Hack Clubbers</h3>
        <%= render "leaderboards/mini_leaderboard", leaderboard: @leaderboard, current_user: nil %>
      </div>
    <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 my-12 items-start" id="signup">
      <div class="w-full relative pb-[56.25%] h-0 overflow-hidden">
        <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/eFVA_ZWnzDk?si=TcEVwiigFZh0Sp_Z&loop=1" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen class="absolute top-0 left-0 w-full h-full rounded-lg"></iframe>
      </div>

      <div class="flex justify-center items-center">
  <div class="max-w-md mx-auto text-center w-full soft-card p-8">
          <%= link_to "Sign in with Hack Club Slack", slack_auth_path, class: "inline-block px-6 py-3 rounded text-white font-bold cursor-pointer border-none w-full my-2 bg-primary" %>

          <div class="my-4 text-gray-300 relative">
            <span class="px-3">or</span>
            <div class="absolute top-1/2 left-0 w-[45%] h-px bg-gray-600"></div>
            <div class="absolute top-1/2 right-0 w-[45%] h-px bg-gray-600"></div>
          </div>

          <%= form_tag email_auth_path, class: "space-y-4", data: { turbo: false } do %>
            <div class="mb-4">
              <%= email_field_tag :email, nil, placeholder: "Enter your email", required: true, class: "w-full px-3 py-3 border border-gray-600 rounded text-base bg-gray-800 text-white" %>
            </div>
            <%= submit_tag "Send sign-in link", class: "inline-block px-6 py-3 rounded text-white font-medium cursor-pointer border-none w-full my-2 bg-blue-600", data: { disable_with: "Sending..." } %>
          <% end %>
          <% if params[:sign_in_email] %>
            <div class="mt-4" style="color:#ff6a00">
              Check your email for a sign-in link!
            </div>
            <% dev_tool do %>
              Because you're on localhost, <%= link_to "click here to view the email", letter_opener_web_path %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
